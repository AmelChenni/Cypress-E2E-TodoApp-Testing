name: Run-Cypress-Tests

on:
push:
branches: [ main ]
pull_request:
branches: [ main ]

jobs:
test:
runs-on: ubuntu-latest

env:
  # Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ© Ø³ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø³ÙŠØ±ÙØ±
  MONGO_DB_URL: ${{ secrets.MONGO_DB_URL }}
  TOKEN_SECRET: ${{ secrets.TOKEN_SECRET }}

steps:
  # 1ï¸âƒ£ Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯
  - name: Checkout repository
    uses: actions/checkout@v4

  # 2ï¸âƒ£ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js 
  - name: Setup Node.js
    uses: actions/setup-node@v4
    with:
      node-version: 16
      cache: "npm"

  # 3ï¸âƒ£ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
  - name: Install dependencies
    run: npm ci

  # 4ï¸âƒ£ ÙƒØ§Ø´ Ù„Ù€ Cypress
  - name: Cache Cypress binary
    uses: actions/cache@v3
    with:
      path: ~/.cache/Cypress
      key: cypress-binary-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

  # 5ï¸âƒ£ Ø¨Ù†Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ React 
  - name: Build React App
    run: npm run build

  # 6ï¸âƒ£ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø®Ù„ÙÙŠ (Ø§Ù„Ù€ API) Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° 8080
  # **Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© Ø§Ù„ØªÙŠ ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§!**
  # **ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø£Ù…Ø± 'npm run start:api' Ù‡Ùˆ Ø§Ù„Ø£Ù…Ø± Ø§Ù„ØµØ­ÙŠØ­ Ù„ØªØ´ØºÙŠÙ„ Ø®Ø§Ø¯Ù…Ùƒ Ø§Ù„Ø®Ù„ÙÙŠ**
  - name: ğŸš€ Start Backend API Server (8080)
    run: npm run start:api &

  # 7ï¸âƒ£ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø£Ù…Ø§Ù…ÙŠ (Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©) Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° 3000
  - name: ğŸŒ Serve Frontend Build Folder (3000)
    run: npx serve -s build -l 3000 &
    env:
      NODE_ENV: production

  # 8ï¸âƒ£ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØµØ¨Ø­ ÙƒÙ„Ø§ Ø§Ù„Ø³ÙŠØ±ÙØ±ÙŠÙ† Ø¬Ø§Ù‡Ø²ÙŠÙ†
  - name: Wait for both servers (3000 & 8080)
    # Ù†Ù†ØªØ¸Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© (3000) ÙˆØ§Ù„Ù€ API (8080)
    run: npx wait-on http://localhost:3000 http://localhost:8080 --timeout 90000

  # 9ï¸âƒ£ ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Cypress
  - name: Run Cypress tests
    run: npx cypress run --browser chrome --headless

  # ğŸ”Ÿ Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù†Ø§ØªØ¬Ø©
  - name: Upload Cypress videos
    if: always() 
    uses: actions/upload-artifact@v4
    with:
      name: cypress-videos
      path: cypress/videos
      if-no-files-found: ignore

  # 1ï¸âƒ£1ï¸âƒ£ Ø­ÙØ¸ Ù„Ù‚Ø·Ø§Øª Ø§Ù„Ø´Ø§Ø´Ø©
  - name: Upload Cypress screenshots
    if: always()
    uses: actions/upload-artifact@v4
    with:
      name: cypress-screenshots
      path: cypress/screenshots
      if-no-files-found: ignore
